#!/bin/bash -x
# perhaps generate .ppid here.
# to be run form within the project.

coverage=$1
project=$2
tsttype=$3
tag=$4

case "$coverage" in
  emma)
    $root/bin/mvn test
    em=$(find . -name coverage.em)
    ec=$(find . -name coverage.ec)
    java -cp ${root}/lib/emma.jar emma report -Dreport.units=count -r html -in ${em},${ec} -sp src/main/java
    ;;
  pit)
    $root/bin/mvn org.pitest:pitest-maven:mutationCoverage
    ;;
  cobertura)
    $root/bin/mvn cobertura:cobertura -Dcobertura.report.format=html
    ;;
  codecover)
    $root/bin/mvn codecover:instrument;
    rm *.clf;
    $root/bin/mvn test
    java -jar $root/lib/codecover-batch.jar analyze --container target/codecover/container.xml \
      --coverage-log *.clf --name default --comment default;
    $root/bin/mvn codecover:report -Dtemplate=$root/meta/HTML_Report_hierarchic.xml
    rm -rf target/site1
    mv target/site target/site1
    $root/bin/mvn codecover:report -Dtemplate=$root/meta/codecover_html_template.xml
    ;;
  mockit)
    $root/bin/mvn test
    ;;
  clover)
    $root/bin/mvn clover2:setup test clover2:aggregate clover2:clover
    ;;
esac

$root/bin/lastcov $tsttype $coverage | tee $root/build/$coverage/$tsttype.$project.$tag.txt
